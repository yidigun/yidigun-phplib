<?php

namespace Yidigun;

/**
 * UTF-8 encoded Hangul Utilities.
 */
class Hangul {

	public static function isHangul($str, $byte_index = 0) {
		return self::isHangulCode(UTF8::ord($str, $byte_index));
	}

	public static function isHangulCode($u) {
		return (
			($u >= 0x1100 && $u <= 0x11ff) || // 한글 자모(Hangul Jamo)
			($u >= 0x3130 && $u <= 0x318F) || // 호환용 한글 자모(Hangul Compatibility Jamo)
			($u >= 0xA960 && $u <= 0xA97F) || // 한글 자모 확장 A(Hangul Jamo Extended A)
			($u >= 0xAC00 && $u <= 0xD7AF) || // 한글 소리 마디(Hangul Syllables)
			($u >= 0xD7B0 && $u <= 0xD7FF)    // 한글 자모 확장 B(Hangul Jamo Extended B)
		);
	}

	/**
	 * Count string length.
	 * A Hangul character are counted as 2 characters.
	 */
	public static function strlen($str) {
		$length = 0;
		UTF8::map(function($c, $u) use (&$length) {
			$length += (self::isHangulCode($u))? 2: 1;
		}, $str);
		return $length;
	}

	/**
	 * Cuts string to given length.
	 * A Hangul character are counted as 2 characters.
	 */
	public static function cut($str, $max_length, $cut_length = -1, $suffix = "...")
	{
		if ($cut_length == -1)
			$cut_length = $max_length - mb_strlen($suffix, 'UTF-8');
		$length = 0;
		$result = '';
		UTF8::map(function($c, $u) use (&$length, &$result, $cut_length) {
			$size = (self::isHangulCode($u))? 2: 1;
			if ($length + $size <= $cut_length) {
				$result .= $c;
				$length += $size;
			}
			else {
				return false;
			}
		}, $str);
		if (strlen($result) < strlen($str))
			$result .= $suffix;
		return $result;
	}

	/**
	 * 문자열을 2벌식 자판 키시퀀스로 변경.
	 * 1. 유니코드 문자열을 정준분해(NFD)하여 첫가끝 코드(조합형)로 변경한다.
	 * 2. 첫가끝 코드에 맞는 
	 */
	public static function toKeySequence($str, $skipspace = false) {
		$result = '';
		UTF8::map(function($c, $u) use (&$result, $skipspace) {
			if (
				($u >= 0x1100 && $u <= 0x11ff) &&
				isset(Hangul::$KOREAN_NFD_KEYSEQMAP[$u])
			) {
				foreach (Hangul::$KOREAN_NFD_KEYSEQMAP[$u] as $kc)
					$result .= UTF8::chr($kc);
			}
			else if ($skipspace && ctype_space($c)) {
				// skip
			}
			else {
				$result .= $c;
			}
		}, Normalizer::normalize($str, Normalizer::FORM_D));
		return $result;
	}

	/**
	 * 한글 NFD 코드를 2벌식 자판 배열과 매핑
	 */
	public static $KOREAN_NFD_KEYSEQMAP = array(
		0x1100 => array(0x3131), // ᄀ
		0x1101 => array(0x3132), // ᄁ
		0x1102 => array(0x3134), // ᄂ
		0x1103 => array(0x3137), // ᄃ
		0x1104 => array(0x3138), // ᄄ
		0x1105 => array(0x3139), // ᄅ
		0x1106 => array(0x3141), // ᄆ
		0x1107 => array(0x3142), // ᄇ
		0x1108 => array(0x3143), // ᄈ
		0x1109 => array(0x3145), // ᄉ
		0x110A => array(0x3146), // ᄊ
		0x110B => array(0x3147), // ᄋ
		0x110C => array(0x3148), // ᄌ
		0x110D => array(0x3149), // ᄍ
		0x110E => array(0x314A), // ᄎ
		0x110F => array(0x314B), // ᄏ
		0x1110 => array(0x314C), // ᄐ
		0x1111 => array(0x314D), // ᄑ
		0x1112 => array(0x314E), // ᄒ
		0x1113 => array(0x3134, 0x3131), // ᄓ
		0x1114 => array(0x3134, 0x3134), // ᄔ
		0x1115 => array(0x3134, 0x3137), // ᄕ
		0x1116 => array(0x3134, 0x3142), // ᄖ
		0x1117 => array(0x3137, 0x3131), // ᄗ
		0x1118 => array(0x3139, 0x3134), // ᄘ
		0x1119 => array(0x3139, 0x3139), // ᄙ
		0x111A => array(0x3139, 0x314E), // ᄚ
		0x111B => array(0x3139, 0x3147), // ᄛ
		0x111C => array(0x3141, 0x3142), // ᄜ
		0x111D => array(0x3141, 0x3147), // ᄝ
		0x111E => array(0x3142, 0x3131), // ᄞ
		0x111F => array(0x3142, 0x3134), // ᄟ
		0x1120 => array(0x3142, 0x3137), // ᄠ
		0x1121 => array(0x3142, 0x3145), // ᄡ
		0x1122 => array(0x3142, 0x3145, 0x3131), // ᄢ
		0x1123 => array(0x3142, 0x3145, 0x3137), // ᄣ
		0x1124 => array(0x3142, 0x3145, 0x3142), // ᄤ
		0x1125 => array(0x3142, 0x3146), // ᄥ
		0x1126 => array(0x3142, 0x3145, 0x3148), // ᄦ
		0x1127 => array(0x3142, 0x3148), // ᄧ
		0x1128 => array(0x3142, 0x314A), // ᄨ
		0x1129 => array(0x3142, 0x314C), // ᄩ
		0x112A => array(0x3142, 0x314D), // ᄪ
		0x112B => array(0x3142, 0x3147), // ᄫ
		0x112C => array(0x3143, 0x3147), // ᄬ
		0x112D => array(0x3145, 0x3131), // ᄭ
		0x112E => array(0x3145, 0x3134), // ᄮ
		0x112F => array(0x3145, 0x3137), // ᄯ
		0x1130 => array(0x3145, 0x3139), // ᄰ
		0x1131 => array(0x3145, 0x3141), // ᄱ
		0x1132 => array(0x3145, 0x3142), // ᄲ
		0x1133 => array(0x3145, 0x3142, 0x3131), // ᄳ
		0x1134 => array(0x3145, 0x3146), // ᄴ
		0x1135 => array(0x3145, 0x3147), // ᄵ
		0x1136 => array(0x3145, 0x3148), // ᄶ
		0x1137 => array(0x3145, 0x314A), // ᄷ
		0x1138 => array(0x3145, 0x314B), // ᄸ
		0x1139 => array(0x3145, 0x314C), // ᄹ
		0x113A => array(0x3145, 0x314D), // ᄺ
		0x113B => array(0x3145, 0x314E), // ᄻ
		0x1141 => array(0x3147, 0x3131), // ᅁ
		0x1142 => array(0x3147, 0x3137), // ᅂ
		0x1143 => array(0x3147, 0x3141), // ᅃ
		0x1144 => array(0x3147, 0x3142), // ᅄ
		0x1145 => array(0x3147, 0x3145), // ᅅ
		0x1147 => array(0x3147, 0x3147), // ᅇ
		0x1148 => array(0x3147, 0x3148), // ᅈ
		0x1149 => array(0x3147, 0x314A), // ᅉ
		0x114A => array(0x3147, 0x314C), // ᅊ
		0x114B => array(0x3147, 0x314D), // ᅋ
		0x114D => array(0x3148, 0x3147), // ᅍ
		0x1152 => array(0x314A, 0x314B), // ᅒ
		0x1153 => array(0x314A, 0x314E), // ᅓ
		0x1156 => array(0x314D, 0x3142), // ᅖ
		0x1157 => array(0x314D, 0x3147), // ᅗ
		0x1158 => array(0x314E, 0x314E), // ᅘ
		0x1161 => array(0x314F), // ᅡ
		0x1162 => array(0x3150), // ᅢ
		0x1163 => array(0x3151), // ᅣ
		0x1164 => array(0x3152), // ᅤ
		0x1165 => array(0x3153), // ᅥ
		0x1166 => array(0x3154), // ᅦ
		0x1167 => array(0x3155), // ᅧ
		0x1168 => array(0x3156), // ᅨ
		0x1169 => array(0x3157), // ᅩ
		0x116A => array(0x3157, 0x314F), // ᅪ
		0x116B => array(0x3157, 0x3150), // ᅫ
		0x116C => array(0x3157, 0x3163), // ᅬ
		0x116D => array(0x315B), // ᅭ
		0x116E => array(0x315C), // ᅮ
		0x116F => array(0x315C, 0x3153), // ᅯ
		0x1170 => array(0x315C, 0x3154), // ᅰ
		0x1171 => array(0x315C, 0x3163), // ᅱ
		0x1172 => array(0x3160), // ᅲ
		0x1173 => array(0x3161), // ᅳ
		0x1174 => array(0x3161, 0x3163), // ᅴ
		0x1175 => array(0x3163), // ᅵ
		0x1176 => array(0x314F, 0x3157), // ᅶ
		0x1177 => array(0x314F, 0x315C), // ᅷ
		0x1178 => array(0x3151, 0x3157), // ᅸ
		0x1179 => array(0x3151, 0x315B), // ᅹ
		0x117A => array(0x3153, 0x3157), // ᅺ
		0x117B => array(0x3153, 0x315C), // ᅻ
		0x117C => array(0x3153, 0x3161), // ᅼ
		0x117D => array(0x3155, 0x3157), // ᅽ
		0x117E => array(0x3155, 0x315C), // ᅾ
		0x117F => array(0x3157, 0x3153), // ᅿ
		0x1180 => array(0x3157, 0x3154), // ᆀ
		0x1181 => array(0x3157, 0x3156), // ᆁ
		0x1182 => array(0x3157, 0x3157), // ᆂ
		0x1183 => array(0x3157, 0x315C), // ᆃ
		0x1184 => array(0x315B, 0x3151), // ᆄ
		0x1185 => array(0x315B, 0x3152), // ᆅ
		0x1186 => array(0x315B, 0x3155), // ᆆ
		0x1187 => array(0x315B, 0x3157), // ᆇ
		0x1188 => array(0x315B, 0x3163), // ᆈ
		0x1189 => array(0x315C, 0x314F), // ᆉ
		0x118A => array(0x315C, 0x3152), // ᆊ
		0x118B => array(0x315C, 0x3153, 0x3161), // ᆋ
		0x118C => array(0x315C, 0x3156), // ᆌ
		0x118D => array(0x315C, 0x315C), // ᆍ
		0x118E => array(0x3160, 0x314F), // ᆎ
		0x118F => array(0x3160, 0x3153), // ᆏ
		0x1190 => array(0x3160, 0x3154), // ᆐ
		0x1191 => array(0x3160, 0x3155), // ᆑ
		0x1192 => array(0x3160, 0x3156), // ᆒ
		0x1193 => array(0x3160, 0x315C), // ᆓ
		0x1194 => array(0x3160, 0x3163), // ᆔ
		0x1195 => array(0x3161, 0x315C), // ᆕ
		0x1196 => array(0x3161, 0x3161), // ᆖ
		0x1197 => array(0x3161, 0x3163, 0x315C), // ᆗ
		0x1198 => array(0x3163, 0x314F), // ᆘ
		0x1199 => array(0x3163, 0x3151), // ᆙ
		0x119A => array(0x3163, 0x3157), // ᆚ
		0x119B => array(0x3163, 0x315C), // ᆛ
		0x119C => array(0x3163, 0x3161), // ᆜ
		0x11A8 => array(0x3131), // ᆨ
		0x11A9 => array(0x3132), // ᆩ
		0x11AA => array(0x3131, 0x3145), // ᆪ
		0x11AB => array(0x3134), // ᆫ
		0x11AC => array(0x3134, 0x3148), // ᆬ
		0x11AD => array(0x3134, 0x314E), // ᆭ
		0x11AE => array(0x3137), // ᆮ
		0x11AF => array(0x3139), // ᆯ
		0x11B0 => array(0x3139, 0x3131), // ᆰ
		0x11B1 => array(0x3139, 0x3141), // ᆱ
		0x11B2 => array(0x3139, 0x3142), // ᆲ
		0x11B3 => array(0x3139, 0x3145), // ᆳ
		0x11B4 => array(0x3139, 0x314C), // ᆴ
		0x11B5 => array(0x3139, 0x314D), // ᆵ
		0x11B6 => array(0x3139, 0x314E), // ᆶ
		0x11B7 => array(0x3141), // ᆷ
		0x11B8 => array(0x3142), // ᆸ
		0x11B9 => array(0x3142, 0x3145), // ᆹ
		0x11BA => array(0x3145), // ᆺ
		0x11BB => array(0x3146), // ᆻ
		0x11BC => array(0x3147), // ᆼ
		0x11BD => array(0x3148), // ᆽ
		0x11BE => array(0x314A), // ᆾ
		0x11BF => array(0x314B), // ᆿ
		0x11C0 => array(0x314C), // ᇀ
		0x11C1 => array(0x314D), // ᇁ
		0x11C2 => array(0x314E), // ᇂ
		0x11C3 => array(0x3131, 0x3139), // ᇃ
		0x11C4 => array(0x3131, 0x3145, 0x3131), // ᇄ
		0x11C5 => array(0x3134, 0x3131), // ᇅ
		0x11C6 => array(0x3134, 0x3137), // ᇆ
		0x11C7 => array(0x3134, 0x3145), // ᇇ
		0x11C9 => array(0x3134, 0x314C), // ᇉ
		0x11CA => array(0x3137, 0x3131), // ᇊ
		0x11CB => array(0x3137, 0x3139), // ᇋ
		0x11CC => array(0x3139, 0x3131, 0x3145), // ᇌ
		0x11CD => array(0x3139, 0x3134), // ᇍ
		0x11CE => array(0x3139, 0x3137), // ᇎ
		0x11CF => array(0x3139, 0x3137, 0x314E), // ᇏ
		0x11D0 => array(0x3139, 0x3139), // ᇐ
		0x11D1 => array(0x3139, 0x3141, 0x3131), // ᇑ
		0x11D2 => array(0x3139, 0x3141, 0x3145), // ᇒ
		0x11D3 => array(0x3139, 0x3142, 0x3145), // ᇓ
		0x11D4 => array(0x3139, 0x3142, 0x314E), // ᇔ
		0x11D5 => array(0x3139, 0x3142, 0x3147), // ᇕ
		0x11D6 => array(0x3139, 0x3146), // ᇖ
		0x11D8 => array(0x3139, 0x314B), // ᇘ
		0x11DA => array(0x3141, 0x3131), // ᇚ
		0x11DB => array(0x3141, 0x3139), // ᇛ
		0x11DC => array(0x3141, 0x3142), // ᇜ
		0x11DD => array(0x3141, 0x3145), // ᇝ
		0x11DE => array(0x3141, 0x3146), // ᇞ
		0x11E0 => array(0x3141, 0x314A), // ᇠ
		0x11E1 => array(0x3141, 0x314E), // ᇡ
		0x11E2 => array(0x3141, 0x3147), // ᇢ
		0x11E3 => array(0x3142, 0x3139), // ᇣ
		0x11E4 => array(0x3142, 0x314D), // ᇤ
		0x11E5 => array(0x3142, 0x314E), // ᇥ
		0x11E6 => array(0x3142, 0x3147), // ᇦ
		0x11E7 => array(0x3145, 0x3131), // ᇧ
		0x11E8 => array(0x3145, 0x3137), // ᇨ
		0x11E9 => array(0x3145, 0x3139), // ᇩ
		0x11EA => array(0x3145, 0x3142), // ᇪ
		0x11EC => array(0x3147, 0x3131), // ᇬ
		0x11ED => array(0x3147, 0x3132), // ᇭ
		0x11EE => array(0x3147, 0x3147), // ᇮ
		0x11EF => array(0x3147, 0x314B), // ᇯ
		0x11F3 => array(0x314D, 0x3142), // ᇳ
		0x11F4 => array(0x314D, 0x3147), // ᇴ
		0x11F5 => array(0x314E, 0x3134), // ᇵ
		0x11F6 => array(0x314E, 0x3139), // ᇶ
		0x11F7 => array(0x314E, 0x3141), // ᇷ
		0x11F8 => array(0x314E, 0x3142), // ᇸ
	);
}
